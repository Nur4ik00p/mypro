import express from "express"
import mongoose from "mongoose"
import cors from "cors"
import multer from "multer"
import { registerValidator, loginValidation, PostCreateValidation } from "./validations/auth.js"
import UserModel from "./models/user.js"
import PostModel from "./models/post.js"
import { PS, uc, checkAdmin } from "./control/index.js"
import checkAuth from "./utils/checkAuth.js"
import fs from "fs"
import path from "path"
import { fileURLToPath } from "url"
import { dirname } from "path"
import { Server } from "socket.io"
import http from "http"
import MessageModel from "./models/message.js"

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
mongoose
  .connect(
    "mongodb+srv://dmitry:dmitrykhorov2009@cluster0.rmyvs.mongodb.net/chat?retryWrites=true&w=majority&appName=Cluster0",
    {
      retryWrites: true,
      w: "majority",
    },
  )
  .then(async () => {
    console.log("‚úÖ MongoDB connected")

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
    try {
      const collection = mongoose.connection.db.collection("messages")
      const indexes = await collection.indexes()

      // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∏–Ω–¥–µ–∫—Å
      const problematicIndex = indexes.find((index) => index.key?.messageId)
      if (problematicIndex) {
        await collection.dropIndex(problematicIndex.name)
        console.log("‚ö†Ô∏è Removed problematic index:", problematicIndex.name)
      }
    } catch (err) {
      console.log("‚ÑπÔ∏è No indexes to fix")
    }
  })
  .catch((err) => console.log("‚ùå MongoDB connection error:", err))

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞
const app = express()
const server = http.createServer(app)
const io = new Server(server, {
  cors: {
    origin: ["http://185.189.167.72:3000"],
    methods: ["GET", "POST"],
    credentials: true,
  },
})
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Multer –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
const storage = multer.diskStorage({
  destination: (_, __, cb) => {
    if (!fs.existsSync("uploads")) {
      fs.mkdirSync("uploads")
    }
    cb(null, "uploads")
  },
  filename: (_, file, cb) => {
    const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9)
    const ext = path.extname(file.originalname).toLowerCase()
    cb(null, uniqueSuffix + ext)
  },
})

const fileFilter = (req, file, cb) => {
  const filetypes = /jpeg|jpg|png|gif/
  const extname = filetypes.test(path.extname(file.originalname).toLowerCase())
  const mimetype = filetypes.test(file.mimetype)

  if (extname && mimetype) {
    return cb(null, true)
  }
  cb("Error: Images and GIFs only!")
}

const upload = multer({
  storage,
  fileFilter,
  limits: { fileSize: 10 * 1024 * 1024 }, // 10MB
})

// Middleware
app.use(
  cors({
    origin: ["http://185.189.167.72:3000"],
    credentials: true,
  })
)
app.use("/uploads", express.static(path.join(__dirname, "uploads")))

// Socket.IO –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
app.get("/api/messages", async (req, res) => {
  try {
    const messages = await MessageModel.find().sort({ createdAt: 1 }).limit(100)
    res.json(messages)
  } catch (err) {
    res.status(500).json({ error: "Server error" })
  }
})

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Socket.IO —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
io.on("connection", async (socket) => {
  console.log("üîå New client connected")

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
  const messages = await MessageModel.find().sort({ createdAt: -1 }).limit(50)
  socket.emit("messageHistory", messages.reverse())

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  socket.on("sendMessage", async (data) => {
    try {
      const newMessage = new MessageModel({
        user: data.userName,
        text: data.text,
        avatarColor: data.avatarColor,
      })

      const savedMessage = await newMessage.save()

      io.emit("receiveMessage", {
        _id: savedMessage._id,
        user: savedMessage.user,
        text: savedMessage.text,
        avatarColor: savedMessage.avatarColor,
        createdAt: savedMessage.createdAt,
      })
    } catch (err) {
      console.error("Error saving message:", err)
      // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–µ–∑ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –ø–æ–ª—è
      if (err.code === 11000) {
        try {
          const fixedMessage = new MessageModel({
            user: data.userName,
            text: data.text,
            avatarColor: data.avatarColor,
            messageId: mongoose.Types.ObjectId(), // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π ID
          })
          await fixedMessage.save()
        } catch (retryErr) {
          console.error("Retry failed:", retryErr)
        }
      }
    }
  })

  socket.on("disconnect", () => {
    console.log("‚ùå Client disconnected")
  })
})

// ====================== –†–æ—É—Ç—ã API ======================

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞
app.get("/api/health", (req, res) => {
  res.status(200).json({
    status: "healthy",
    timestamp: new Date().toISOString(),
    socket: io.engine.clientsCount > 0 ? "connected" : "disconnected",
  })
})

app.patch(
  "/users/:id",
  checkAuth,
  upload.fields([
    { name: "avatar", maxCount: 1 },
    { name: "cover", maxCount: 1 },
  ]),
  uc.updateUser,
)
app.post("/auth/login", loginValidation, uc.login)
app.post(
  "/auth/register",
  upload.fields([
    { name: "avatar", maxCount: 1 },
    { name: "cover", maxCount: 1 },
  ]),
  registerValidator,
  uc.register,
)
app.get("/auth/me", checkAuth, uc.getMe)
app.patch(
  "/users/:id",
  checkAuth,
  upload.fields([
    { name: "avatar", maxCount: 1 },
    { name: "cover", maxCount: 1 },
  ]),
  uc.updateUser,
)
app.get("/posts", PS.getAll)
app.get("/posts/tags", PS.tagsAll)
app.get("/tags", PS.tagsAll)
app.get("/posts/similar/:id", PS.getPostsBySameTitle)
app.post("/posts", checkAuth, PostCreateValidation, PS.create)
app.post("/posts/like/:id", checkAuth, PS.likePost)
app.post("/posts/dislike/:id", checkAuth, PS.dislikePost)
app.delete("/posts/reaction/:id", checkAuth, PS.removeReaction)
app.get("/posts/reaction/:id", checkAuth, PS.checkUserReaction)
app.get("/posts/user/:userId", PS.getPostsByUser)
app.get("/posts/:id", PS.getOne)
app.patch("/posts/:id", checkAuth, PS.update)
app.delete("/posts/:id", checkAuth, PS.remove)
app.post("/upload", checkAuth, upload.single("image"), (req, res) => {
  if (!req.file) {
    return res.status(400).json({ message: "No file uploaded or invalid file type" })
  }

  UserModel.findByIdAndUpdate(req.userId, {
    $push: {
      activityLog: {
        action: "file_upload",
        details: {
          filename: req.file.filename,
          size: req.file.size,
        },
      },
    },
  }).catch(console.error)

  res.json({
    url: `/uploads/${req.file.filename}`,
  })
})

app.post("/users/request-verification", checkAuth, upload.array("documents", 3), uc.requestVerification)
app.post("/users/verify", checkAuth, uc.verifyUser)

// –†–æ—É—Ç—ã –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
app.post("/users/favorites", checkAuth, uc.addToFavorites)
app.delete("/users/favorites/:postId", checkAuth, uc.removeFromFavorites)
app.get("/users/favorites", checkAuth, uc.getFavorites)

// –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ä–æ—É—Ç—ã
app.get("/admin/stats", checkAuth, checkAdmin, async (req, res) => {
  try {
    const usersCount = await UserModel.countDocuments()
    const postsCount = await PostModel.countDocuments()

    res.json({
      success: true,
      stats: { usersCount, postsCount },
    })
  } catch (err) {
    res.status(500).json({
      success: false,
      message: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
    })
  }
})

app.get("/admin/users", checkAuth, checkAdmin, async (req, res) => {
  try {
    const users = await UserModel.find().select("-passwordHash -__v -verificationCode").lean()

    res.json({
      success: true,
      users,
    })
  } catch (err) {
    console.error(err)
    res.status(500).json({
      success: false,
      message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
    })
  }
})
app.patch("/admin/users/:id/account-type", checkAuth, checkAdmin, async (req, res) => {
  try {
    const { accountType } = req.body
    if (!["user", "verified_user", "shop", "admin"].includes(accountType)) {
      return res.status(400).json({
        success: false,
        message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞",
      })
    }

    const updatedUser = await UserModel.findByIdAndUpdate(
      req.params.id,
      {
        accountType,
        verified: accountType === "user" ? "unverified" : "verified",
      },
      { new: true },
    ).select("-passwordHash -__v -verificationCode")

    res.json({
      success: true,
      user: updatedUser,
    })
  } catch (err) {
    console.error(err)
    res.status(500).json({
      success: false,
      message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–∏–ø–∞ –∞–∫–∫–∞—É–Ω—Ç–∞",
    })
  }
})
app.post("/admin/verify-account", checkAuth, checkAdmin, uc.approveVerification)
app.post("/admin/reject-verification", checkAuth, checkAdmin, uc.rejectVerification)

// –ü—É–±–ª–∏—á–Ω—ã–µ —Ä–æ—É—Ç—ã
app.get("/users/:id", async (req, res) => {
  try {
    const user = await UserModel.findById(req.params.id).select("-passwordHash -__v -verificationCode").lean()

    if (!user) {
      return res.status(404).json({
        success: false,
        message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
      })
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    let isSubscribed = false
    if (req.userId) {
      const currentUser = await UserModel.findById(req.userId)
      isSubscribed = currentUser.subscriptions.includes(req.params.id)
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–æ–∫
    const followersCount = await UserModel.countDocuments({
      subscriptions: req.params.id,
    })

    const subscriptionsCount = await UserModel.countDocuments({
      followers: req.params.id,
    })

    res.json({
      success: true,
      user,
      isSubscribed,
      followersCount,
      subscriptionsCount,
    })
  } catch (err) {
    res.status(500).json({
      success: false,
      message: err.message,
    })
  }
})
app.post("/users/subscribe/:id", checkAuth, uc.subscribe)
app.delete("/users/unsubscribe/:id", checkAuth, uc.unsubscribe)

// ====================== –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ======================
app.use((req, res) => {
  res.status(404).json({
    success: false,
    message: "Not found",
    endpoint: `${req.method} ${req.path}`,
  })
})

app.use((err, req, res, next) => {
  console.error("üî• Server error:", err.stack)
  res.status(500).json({
    success: false,
    message: "Internal server error",
    error: process.env.NODE_ENV === "development" ? err.message : undefined,
  })
})

// ====================== –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ======================
const PORT = process.env.PORT || 4001
server.listen(PORT, () => {
  console.log(`\nüöÄ Server started on port ${PORT}`)
  console.log(`üîó HTTP: http://localhost:${PORT}`)
  console.log(`üõ∞Ô∏è Socket.IO: ws://localhost:${PORT}`)
  console.log(`üìÅ Uploads: http://localhost:${PORT}/uploads`)
})
